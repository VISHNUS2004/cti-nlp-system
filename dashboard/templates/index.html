<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CTI-NLP Dashboard SYSTEM</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f9fafb;
      }
      .card {
        margin-top: 20px;
      }
      #loader,
      #ingestLoader {
        display: none;
      }
      pre {
        white-space: pre-wrap;
        word-wrap: break-word;
      }
    </style>
  </head>
  <body>
    <div class="container py-5">
      <h2 class="text-center mb-4">Cyber Threat Intelligence - NLP Analysis</h2>

      <!-- Threat Analysis Section -->
      <div class="mb-4">
        <textarea
          id="inputText"
          class="form-control"
          rows="6"
          placeholder="Paste threat intelligence report or suspicious text here..."
        ></textarea>
      </div>
      <div class="d-grid gap-2 col-6 mx-auto">
        <button class="btn btn-primary" onclick="analyzeText()">
          Analyze Threat
        </button>
      </div>

      <div class="text-center my-3">
        <div class="spinner-border text-primary" role="status" id="loader">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>

      <div id="results" class="mt-4" style="display: none">
        <h4>Analysis Results</h4>

        <div class="card">
          <div class="card-header">Threat Type</div>
          <div class="card-body"><p id="threatType"></p></div>
        </div>

        <div class="card">
          <div class="card-header">Severity</div>
          <div class="card-body"><p id="severity"></p></div>
        </div>

        <div class="card">
          <div class="card-header">Entities (NER)</div>
          <div class="card-body"><pre id="entities"></pre></div>
        </div>

        <div class="d-flex justify-content-end mt-3">
          <button
            class="btn btn-outline-secondary me-2"
            onclick="copyResults()"
          >
            Copy
          </button>
          <button class="btn btn-outline-success" onclick="downloadResults()">
            Download
          </button>
        </div>
      </div>

      <hr class="my-5" />

      <!-- Real-time Ingestion Section -->
      <h4>Real-Time Ingestion</h4>
      <div class="d-grid gap-2 col-6 mx-auto">
        <button class="btn btn-warning" onclick="runIngestion()">
          Run Ingestion Now
        </button>
      </div>

      <div class="text-center my-3">
        <div
          class="spinner-border text-warning"
          role="status"
          id="ingestLoader"
        >
          <span class="visually-hidden">Ingesting...</span>
        </div>
      </div>

      <div id="ingestResults" class="mt-4" style="display: none">
        <div class="card">
          <div class="card-header">Last Ingestion Summary</div>
          <div class="card-body">
            <pre id="ingestSummary"></pre>
          </div>
        </div>
      </div>
    </div>

    <script>
      function analyzeText() {
        const inputText = document.getElementById("inputText").value;
        if (!inputText.trim()) {
          alert("Please enter some text to analyze.");
          return;
        }

        document.getElementById("loader").style.display = "block";
        document.getElementById("results").style.display = "none";

        fetch("/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: inputText }),
        })
          .then((r) => r.json())
          .then((data) => {
            document.getElementById("loader").style.display = "none";
            if (data.error) {
              alert("Error: " + data.error);
              return;
            }

            document.getElementById("threatType").innerText =
              data.threat_type || "N/A";
            document.getElementById("severity").innerText =
              data.severity || "N/A";
            document.getElementById("entities").innerText = JSON.stringify(
              data.entities,
              null,
              2
            );

            document.getElementById("results").style.display = "block";
          })
          .catch((err) => {
            document.getElementById("loader").style.display = "none";
            alert("Request failed. Check server.");
            console.error(err);
          });
      }

      function runIngestion() {
        document.getElementById("ingestLoader").style.display = "block";
        document.getElementById("ingestResults").style.display = "none";

        fetch("/ingest_now", { method: "POST" })
          .then((r) => r.json())
          .then((data) => {
            document.getElementById("ingestLoader").style.display = "none";

            if (data.status !== "success") {
              alert("Ingestion failed: " + (data.message || "Unknown error"));
              return;
            }

            document.getElementById("ingestSummary").innerText = JSON.stringify(
              data.ingestion_summary,
              null,
              2
            );
            document.getElementById("ingestResults").style.display = "block";
          })
          .catch((err) => {
            document.getElementById("ingestLoader").style.display = "none";
            alert("Ingestion request failed.");
            console.error(err);
          });
      }

      function copyResults() {
        const resultsText = `
Threat Type: ${document.getElementById("threatType").innerText}
Severity: ${document.getElementById("severity").innerText}
Entities: ${document.getElementById("entities").innerText}
  `.trim();

        navigator.clipboard.writeText(resultsText);
        alert("Results copied to clipboard.");
      }

      function downloadResults() {
        const resultObj = {
          threat_type: document.getElementById("threatType").innerText,
          severity: document.getElementById("severity").innerText,
          entities: JSON.parse(document.getElementById("entities").innerText),
        };

        const blob = new Blob([JSON.stringify(resultObj, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "threat_analysis_result.json";
        a.click();
        URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>
