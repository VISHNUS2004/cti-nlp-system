<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>CTI-NLP Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background-color: #0d1117;
        color: #c9d1d9;
        font-family: "Courier New", Courier, monospace;
        padding: 2rem 1rem;
      }

      h1 {
        color: #58a6ff;
        font-size: 2.2rem;
        text-align: center;
        margin-bottom: 2rem;
      }

      .card {
        background-color: #161b22;
        border: 1px solid #30363d;
        margin-top: 1.5rem;
      }

      .btn-primary {
        background-color: #238636;
        border: none;
      }

      .btn-primary:hover {
        background-color: #2ea043;
      }

      .badge {
        background-color: #58a6ff;
        color: #0d1117;
        margin: 4px;
      }

      .spinner-border {
        display: none;
      }

      .loading .spinner-border {
        display: inline-block;
      }

      #footer {
        text-align: center;
        margin-top: 3rem;
        font-size: 0.9rem;
        color: #444;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç CTI-NLP Threat Analyzer</h1>

      <form id="analyze-form">
        <div class="mb-3">
          <label for="inputText" class="form-label"
            >Paste Threat Intel Report:</label
          >
          <textarea
            class="form-control"
            id="inputText"
            rows="5"
            placeholder="E.g., Emotet is spreading via phishing campaigns targeting Microsoft..."
          ></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Analyze</button>
        <div
          class="spinner-border text-light ms-3"
          role="status"
          id="loadingSpinner"
        ></div>
      </form>

      <div id="result-container" class="d-none">
        <div class="card p-3">
          <h5>üìã Threat Type</h5>
          <p id="threat-type" class="fs-5 text-success"></p>

          <h5>üî• Severity</h5>
          <p id="severity" class="fs-5 text-warning"></p>

          <h5>üìå Extracted Entities</h5>
          <div id="entities"></div>

          <button id="downloadBtn" class="btn btn-outline-light mt-3">
            Download JSON
          </button>
        </div>
      </div>

      <div id="footer">¬© 2025 CTI-NLP ‚Ä¢ ATME AI/ML</div>
    </div>

    <script>
      const form = document.getElementById("analyze-form");
      const spinner = document.getElementById("loadingSpinner");
      const resultContainer = document.getElementById("result-container");

      form.addEventListener("submit", async function (e) {
        e.preventDefault();
        const inputText = document.getElementById("inputText").value;
        if (!inputText.trim()) return;

        spinner.style.display = "inline-block";
        resultContainer.classList.add("d-none");

        try {
          const response = await fetch("/analyze", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: inputText }),
          });

          const result = await response.json();
          spinner.style.display = "none";

          if (result.error) {
            alert("Error: " + result.error);
            return;
          }

          document.getElementById("threat-type").textContent =
            result.threat_type;
          document.getElementById("severity").textContent = result.severity;

          const entitiesDiv = document.getElementById("entities");
          entitiesDiv.innerHTML = "";
          result.entities.forEach((entity) => {
            const badge = document.createElement("span");
            badge.className = "badge";
            badge.textContent = `${entity.word} (${entity.entity_group})`;
            entitiesDiv.appendChild(badge);
          });

          // Store result for download
          window.latestCTIResult = result;
          resultContainer.classList.remove("d-none");
        } catch (err) {
          spinner.style.display = "none";
          alert("Request failed: " + err.message);
        }
      });

      document.getElementById("downloadBtn").addEventListener("click", () => {
        const dataStr = JSON.stringify(window.latestCTIResult, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "cti_analysis_result.json";
        a.click();
      });
    </script>
  </body>
</html>
