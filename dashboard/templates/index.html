<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>CTI-NLP Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background-color: #0d1117;
        color: #c9d1d9;
        font-family: "Courier New", Courier, monospace;
        padding: 2rem 1rem;
      }

      h1 {
        color: #58a6ff;
        font-size: 2.2rem;
        text-align: center;
        margin-bottom: 2rem;
      }

      .card {
        background-color: #161b22;
        border: 1px solid #30363d;
        margin-top: 1.5rem;
      }

      .btn-primary {
        background-color: #238636;
        border: none;
      }

      .btn-primary:hover {
        background-color: #2ea043;
      }

      .btn-outline-light {
        border-color: #58a6ff;
        color: #58a6ff;
      }

      .btn-outline-light:hover {
        background-color: #58a6ff;
        color: #0d1117;
      }

      .badge {
        background-color: #58a6ff;
        color: #0d1117;
        margin: 4px;
      }

      .spinner-border {
        display: none;
      }

      .table th,
      .table td {
        vertical-align: middle;
      }

      #footer {
        text-align: center;
        margin-top: 3rem;
        font-size: 0.9rem;
        color: #444;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>CTI-NLP Threat Analyzer</h1>

      <!-- Single Text Input -->
      <form id="analyze-form">
        <div class="mb-3">
          <label for="inputText" class="form-label"
            >Paste Threat Intel Report:</label
          >
          <textarea
            class="form-control"
            id="inputText"
            rows="5"
            placeholder="E.g., Emotet is spreading via phishing campaigns targeting Microsoft..."
          ></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Analyze</button>
        <div
          class="spinner-border text-light ms-3"
          role="status"
          id="loadingSpinner"
        ></div>
      </form>

      <!-- Results Display -->
      <div id="result-container" class="d-none mt-4">
        <div class="card p-3">
          <h5 class="mb-3">Analysis Result</h5>

          <table class="table table-dark table-bordered">
            <tbody>
              <tr>
                <th>Threat Type</th>
                <td id="threat-type">—</td>
                <td>
                  <button
                    class="btn btn-sm btn-secondary"
                    onclick="copyText('threat-type')"
                  ></button>
                </td>
              </tr>
              <tr>
                <th>Severity</th>
                <td id="severity">—</td>
                <td>
                  <button
                    class="btn btn-sm btn-secondary"
                    onclick="copyText('severity')"
                  ></button>
                </td>
              </tr>
              <tr>
                <th>Entities</th>
                <td id="entities">—</td>
                <td>
                  <button
                    class="btn btn-sm btn-secondary"
                    onclick="copyEntities()"
                  ></button>
                </td>
              </tr>
            </tbody>
          </table>

          <button id="downloadBtn" class="btn btn-outline-light mt-2">
            Download JSON
          </button>
        </div>
      </div>

      <hr class="my-4" />

      <!-- File Upload -->
      <h4>Upload CSV for Batch Threat Analysis</h4>
      <form id="upload-form">
        <div class="mb-3">
          <input type="file" id="csvFile" accept=".csv" class="form-control" />
        </div>
        <button type="submit" class="btn btn-primary">Upload & Analyze</button>
        <div
          class="spinner-border text-light ms-3"
          role="status"
          id="uploadSpinner"
        ></div>
      </form>

      <div id="footer">© 2025 CTI-NLP • ATME AI/ML</div>
    </div>

    <script>
      const form = document.getElementById("analyze-form");
      const spinner = document.getElementById("loadingSpinner");
      const resultContainer = document.getElementById("result-container");

      form.addEventListener("submit", async function (e) {
        e.preventDefault();
        const inputText = document.getElementById("inputText").value;
        if (!inputText.trim()) return;

        spinner.style.display = "inline-block";
        resultContainer.classList.add("d-none");

        try {
          const response = await fetch("/analyze", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: inputText }),
          });

          const result = await response.json();
          spinner.style.display = "none";

          if (result.error) {
            alert("Error: " + result.error);
            return;
          }

          document.getElementById("threat-type").textContent =
            result.threat_type;
          document.getElementById("severity").textContent = result.severity;

          const entities = result.entities
            .map((e) => `${e.word} (${e.entity_group})`)
            .join(", ");
          document.getElementById("entities").textContent = entities;

          window.latestCTIResult = result;
          resultContainer.classList.remove("d-none");
        } catch (err) {
          spinner.style.display = "none";
          alert("Request failed: " + err.message);
        }
      });

      function copyText(id) {
        const text = document.getElementById(id).textContent;
        navigator.clipboard.writeText(text);
      }

      function copyEntities() {
        const text = document.getElementById("entities").textContent;
        navigator.clipboard.writeText(text);
      }

      document.getElementById("downloadBtn").addEventListener("click", () => {
        const dataStr = JSON.stringify(window.latestCTIResult, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "cti_analysis_result.json";
        a.click();
      });

      const uploadForm = document.getElementById("upload-form");
      const uploadSpinner = document.getElementById("uploadSpinner");

      uploadForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        const fileInput = document.getElementById("csvFile");
        const file = fileInput.files[0];
        if (!file) return alert("Please upload a CSV file");

        const formData = new FormData();
        formData.append("file", file);
        uploadSpinner.style.display = "inline-block";

        try {
          const response = await fetch("/upload_csv", {
            method: "POST",
            body: formData,
          });

          if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "cti_batch_results.json";
            a.click();
          } else {
            const err = await response.json();
            alert("Error: " + err.error);
          }
        } catch (err) {
          alert("Failed: " + err.message);
        }

        uploadSpinner.style.display = "none";
      });
    </script>
  </body>
</html>
